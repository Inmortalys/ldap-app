<div class="reset-container">
    <!-- Loading State -->
    <div *ngIf="validating" class="loading-state">
        <div class="spinner"></div>
        <p>Validando enlace...</p>
    </div>

    <!-- Invalid Token -->
    <div *ngIf="!validating && tokenValid === false" class="error-container">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h1>Enlace Inv√°lido</h1>
        <p class="error-text">{{ tokenError }}</p>
        <a href="/login" class="btn-primary">Volver al inicio de sesi√≥n</a>
    </div>

    <!-- Success State -->
    <div *ngIf="success" class="success-container">
        <div class="success-icon">‚úÖ</div>
        <h1>¬°Contrase√±a Cambiada!</h1>
        <p>Tu contrase√±a ha sido actualizada correctamente.</p>
        <p class="redirect-text">Redirigiendo al inicio de sesi√≥n...</p>
    </div>

    <!-- Valid Token - Show Forms -->
    <div *ngIf="!validating && tokenValid === true && !success" class="form-container">
        <div class="header">
            <h1>üîë Cambiar Contrase√±a</h1>
            <p class="subtitle">Enlace v√°lido por: <strong>{{ getTimeRemaining() }}</strong></p>
        </div>

        <!-- Error Message -->
        <div *ngIf="error" class="error-message">
            ‚ö†Ô∏è {{ error }}
        </div>

        <!-- Step 1: Authentication -->
        <div *ngIf="!authenticated" class="auth-form">
            <h2>Paso 1: Verificar Identidad</h2>
            <p class="form-description">Por favor, ingrese sus credenciales actuales para continuar.</p>

            <div class="form-group">
                <label for="username">Usuario</label>
                <input type="text" id="username" [(ngModel)]="username" class="form-control"
                    placeholder="Ingrese su nombre de usuario" [disabled]="authenticating" />
            </div>

            <div class="form-group">
                <label for="currentPassword">Contrase√±a Actual</label>
                <input type="password" id="currentPassword" [(ngModel)]="currentPassword" class="form-control"
                    placeholder="Ingrese su contrase√±a actual" [disabled]="authenticating" />
            </div>

            <button class="btn-primary" (click)="authenticate()"
                [disabled]="!username || !currentPassword || authenticating">
                <span *ngIf="!authenticating">Continuar</span>
                <span *ngIf="authenticating">‚è≥ Verificando...</span>
            </button>
        </div>

        <!-- Step 2: Password Change -->
        <div *ngIf="authenticated" class="password-form">
            <h2>Paso 2: Nueva Contrase√±a</h2>
            <p class="form-description">Ingrese su nueva contrase√±a.</p>

            <div class="form-group">
                <label for="newPassword">Nueva Contrase√±a</label>
                <input type="password" id="newPassword" [(ngModel)]="newPassword" (input)="validatePassword()"
                    class="form-control" placeholder="Ingrese la nueva contrase√±a" [disabled]="resetting" />
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirmar Contrase√±a</label>
                <input type="password" id="confirmPassword" [(ngModel)]="confirmPassword" class="form-control"
                    placeholder="Confirme la nueva contrase√±a" [disabled]="resetting" />
            </div>

            <!-- Password Strength Meter -->
            <div class="password-strength" *ngIf="newPassword">
                <div class="strength-label">Fortaleza de la contrase√±a:</div>
                <div class="strength-bar">
                    <div class="strength-fill" [class]="getPasswordStrengthClass()"
                        [style.width.%]="getPasswordStrength()"></div>
                </div>
            </div>

            <!-- Password Requirements -->
            <div class="password-requirements">
                <h3>Requisitos de Contrase√±a:</h3>
                <ul>
                    <li [class.valid]="passwordValidation.requirements.minLength">
                        <span class="icon">{{ passwordValidation.requirements.minLength ? '‚úì' : '‚úó' }}</span>
                        M√≠nimo 12 caracteres
                    </li>
                    <li [class.valid]="passwordValidation.requirements.hasUppercase">
                        <span class="icon">{{ passwordValidation.requirements.hasUppercase ? '‚úì' : '‚úó' }}</span>
                        Al menos una letra may√∫scula
                    </li>
                    <li [class.valid]="passwordValidation.requirements.hasLowercase">
                        <span class="icon">{{ passwordValidation.requirements.hasLowercase ? '‚úì' : '‚úó' }}</span>
                        Al menos una letra min√∫scula
                    </li>
                    <li [class.valid]="passwordValidation.requirements.hasNumber">
                        <span class="icon">{{ passwordValidation.requirements.hasNumber ? '‚úì' : '‚úó' }}</span>
                        Al menos un n√∫mero
                    </li>
                    <li [class.valid]="passwordValidation.requirements.hasSpecial">
                        <span class="icon">{{ passwordValidation.requirements.hasSpecial ? '‚úì' : '‚úó' }}</span>
                        Al menos un car√°cter especial
                    </li>
                    <li [class.valid]="passwordValidation.requirements.notContainsUsername">
                        <span class="icon">{{ passwordValidation.requirements.notContainsUsername ? '‚úì' : '‚úó' }}</span>
                        No contiene el nombre de usuario
                    </li>
                </ul>
            </div>

            <div *ngIf="newPassword && confirmPassword && newPassword !== confirmPassword" class="password-mismatch">
                ‚ö†Ô∏è Las contrase√±as no coinciden
            </div>

            <button class="btn-primary" (click)="submitPasswordReset()"
                [disabled]="!passwordValidation.valid || newPassword !== confirmPassword || resetting">
                <span *ngIf="!resetting">Cambiar Contrase√±a</span>
                <span *ngIf="resetting">‚è≥ Cambiando...</span>
            </button>
        </div>
    </div>
</div>